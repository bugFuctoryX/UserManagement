@page "/"
@page "/login"
@rendermode InteractiveServer

<main class="auth-main">
    <div class="page-card">
        <h1 class="page-title">Login</h1>
        <TelerikForm Model="@loginModel" OnSubmit="@OnSubmit" Class="form-grid">
            <FormValidation>
                <DataAnnotationsValidator />
            </FormValidation>

            <FormItems>
                <FormItem LabelText="Username">
                    <Template>
                        <TelerikTextBox @bind-Value="loginModel.UserName"
                                        Placeholder="Username"
                                        Width="100%" />
                        <TelerikValidationMessage For="@(() => loginModel.UserName)" />
                    </Template>
                </FormItem>

                <FormItem LabelText="Password">
                    <Template>
                        <TelerikTextBox @bind-Value="loginModel.Password"
                                        Placeholder="Password"
                                        Width="100%"
                                        Password="true" />
                        <TelerikValidationMessage For="@(() => loginModel.Password)" />
                    </Template>
                </FormItem>
            </FormItems>
            <FormButtons>
                <TelerikButton ButtonType="ButtonType.Submit"
                               ThemeColor="ThemeColor.Primary"
                               Enabled="@(!isBusy)">
                    @(isBusy ? "Signing in..." : "Sign in")
                </TelerikButton>
            </FormButtons>
        </TelerikForm>
    </div>
</main>

@if (!string.IsNullOrWhiteSpace(statusMessage))
{
    <p class="text-success mt-3">@statusMessage</p>
}

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <p class="text-danger mt-3">@errorMessage</p>
}

@code {
    private readonly LoginModel loginModel = new();
    private string? statusMessage;
    private string? errorMessage;
    private bool isBusy;

    [Inject] private IMediator Mediator { get; set; } = default!;

    private async Task OnSubmit()
    {
        statusMessage = null;
        errorMessage = null;
        isBusy = true;

        var result = await Mediator.Send(new LoginCommand(loginModel.UserName, loginModel.Password));

        if (result.IsSuccess && result.Value is not null)
        {
            var fullName = $"{result.Value.FirstName} {result.Value.LastName}".Trim();
            statusMessage = string.IsNullOrWhiteSpace(fullName)
                ? $"Welcome {result.Value.UserName}"
                : $"Welcome {fullName}";

            loginModel.Password = string.Empty;
        }
        else
        {
            errorMessage = result.Error?.Message ?? "Login failed. Please try again.";
        }

        isBusy = false;
    }
}
