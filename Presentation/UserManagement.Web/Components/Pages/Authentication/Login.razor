@page "/"
@page "/login"

<section class="auth-shell">
    <TelerikCard Class="auth-card">
        <CardBody>
            <TelerikStackLayout Orientation="@StackLayoutOrientation.Horizontal" Class="auth-stack">
                <div class="auth-info">
                    <TelerikBadge ThemeColor="ThemeColor.Info"></TelerikBadge>
                    <h1>Welcome</h1>
                    <p>Sign in to manage users and keep profiles up to date across your system.</p>
                    <ul>
                        <li>Fast access with Telerik UI</li>
                        <li>Responsive layout for any device</li>
                        <li>Simple, clear user management</li>
                    </ul>
                </div>

                <div class="auth-form">
                    <h2 class="k-h5 mb-3">Login</h2>

                    <TelerikForm Model="@loginModel" OnSubmit="@OnSubmit" Class="form-grid">
                        <FormValidation>
                            <DataAnnotationsValidator />
                        </FormValidation>

                        <FormItems>
                            <FormItem LabelText="Username">
                                <Template>
                                    <TelerikTextBox @bind-Value="loginModel.UserName"
                                                    Placeholder="Enter username"
                                                    Width="100%" />
                                    <TelerikValidationMessage For="@(() => loginModel.UserName)" />
                                </Template>
                            </FormItem>

                            <FormItem LabelText="Password">
                                <Template>
                                    <TelerikTextBox @bind-Value="loginModel.Password"
                                                    Placeholder="Enter password"
                                                    Width="100%"
                                                    Password="true" />
                                    <TelerikValidationMessage For="@(() => loginModel.Password)" />
                                </Template>
                            </FormItem>
                        </FormItems>

                        <FormButtons>
                            <TelerikButton ButtonType="ButtonType.Submit"
                                           ThemeColor="ThemeColor.Primary"
                                           Enabled="@(!isBusy)">
                                @(isBusy ? "Signing in..." : "Sign in")
                            </TelerikButton>
                        </FormButtons>
                    </TelerikForm>

                    @if (!string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <div class="auth-status text-danger">@errorMessage</div>
                    }
                </div>
            </TelerikStackLayout>
        </CardBody>
    </TelerikCard>
</section>

@code {
    private readonly LoginModel loginModel = new();
    private string? errorMessage;
    private bool isBusy;

    [Inject] private IMediator Mediator { get; set; } = default!;
    [Inject] private NavigationManager NavigationManager { get; set; } = default!;

    private async Task OnSubmit()
    {
        errorMessage = null;
        isBusy = true;

        var result = await Mediator.Send(loginModel.ToLoginCommand());

        if (result.IsSuccess && result.Value is not null)
        {
            loginModel.Password = string.Empty;
            isBusy = false;

            NavigationManager.NavigateTo("/users");
            return;
        }

        errorMessage = result.Error?.Message ?? "Login failed. Please try again.";
        isBusy = false;
    }
}
