@page "/"
@page "/login"

<section class="auth-shell">
    <TelerikCard Class="auth-card">
        <CardBody>
            <TelerikStackLayout Orientation="@StackLayoutOrientation.Horizontal" Class="auth-stack">
                <div class="auth-info">
                    <TelerikBadge ThemeColor="ThemeColor.Info"></TelerikBadge>
                    <h1>Welcome</h1>
                    <p>Sign in to manage users and keep profiles up to date across your system.</p>
                    <ul>
                        <li>Fast access with Telerik UI</li>
                        <li>Responsive layout for any device</li>
                        <li>Simple, clear user management</li>
                    </ul>
                </div>

                <div class="auth-form">
                    <h2 class="k-h5 mb-3">Login</h2>

                    <TelerikForm Model="@loginUser" OnSubmit="@OnSubmit" Class="form-grid">
                        <FormValidation>
                            <DataAnnotationsValidator />
                        </FormValidation>

                        <FormItems>
                            <FormItem LabelText="Username">
                                <Template>
                                    <TelerikTextBox @bind-Value="loginUser.UserName"
                                                    Placeholder="Enter username"
                                                    Width="100%" />
                                    <TelerikValidationMessage For="@(() => loginUser.UserName)" />
                                </Template>
                            </FormItem>

                            <FormItem LabelText="Password">
                                <Template>
                                    <TelerikTextBox @bind-Value="loginUser.Password"
                                                    Placeholder="Enter password"
                                                    Width="100%"
                                                    Password="true" />
                                    <TelerikValidationMessage For="@(() => loginUser.Password)" />
                                </Template>
                            </FormItem>
                        </FormItems>

                        <FormButtons>
                            <TelerikButton ButtonType="ButtonType.Submit"
                                           ThemeColor="ThemeColor.Primary"
                                           Enabled="@(!isBusy)">
                                @(isBusy ? "Signing in..." : "Sign in")
                            </TelerikButton>
                        </FormButtons>
                    </TelerikForm>

                    @if (!string.IsNullOrWhiteSpace(errorMessage))
                    {
                        <div class="auth-status text-danger">@errorMessage</div>
                    }
                </div>
            </TelerikStackLayout>
        </CardBody>
    </TelerikCard>
</section>

@code {
    private readonly LoginUser loginUser = new();
    private string? errorMessage;
    private bool isBusy;

    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;
    [Inject] private AuthenticationStateProvider AuthStateProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        if (state.User.Identity?.IsAuthenticated == true)
        {
            Nav.NavigateTo("/users", forceLoad: true);
        }
    }

    private async Task OnSubmit()
    {
        isBusy = true;
        errorMessage = null;

        try
        {
            await JS.InvokeVoidAsync("postSignIn",
                "/auth/signin",
                loginUser.UserName,
                loginUser.Password,
                "/users");

            isBusy = false;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            isBusy = false;
        }
    }
}
