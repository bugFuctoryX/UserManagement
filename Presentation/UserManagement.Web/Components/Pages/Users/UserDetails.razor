@page "/users/{UserId:guid}"

<h3>User details</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div style="color:#c00">@errorMessage</div>
}
else if (model is not null)
{
    <UserDetailsForm Model="model"
                     BirthDate="birthDate"
                     BirthDateChanged="OnBirthDateChanged"
                     FullName="@FullName"
                     IsSaving="isSaving"
                     SaveMessage="@SaveMessage"
                     SaveError="@SaveError"
                     OnBack="GoBack"
                     OnSave="UpdateAsync" />
}

@code {
    [Parameter] public Guid UserId { get; set; }

    private UserViewModel? model;
    private DateTime birthDate;

    private bool isLoading = true;
    private bool isSaving;

    private string? errorMessage;
    private string? SaveError { get; set; }
    private string? SaveMessage { get; set; }

    [Inject] private IMediator Mediator { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private string FullName => model is null ? string.Empty : $"{model.FirstName} {model.LastName}";

    protected override async Task OnInitializedAsync()
        => await LoadAsync();

    private async Task LoadAsync()
    {
        isLoading = true;
        errorMessage = null;
        SaveError = null;
        SaveMessage = null;

        try
        {
            var result = await Mediator.Send(new GetUserByIdQuery(UserId));

            if (result.IsSuccess && result.Value is not null)
            {
                model = result.Value.ToUserModel();
                birthDate = model.BirthDate.ToDateTime(TimeOnly.MinValue);
            }
            else
            {
                errorMessage = result.Error?.Message ?? "User not found.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private Task OnBirthDateChanged(DateTime value)
    {
        birthDate = value;
        return Task.CompletedTask;
    }

    private async Task UpdateAsync()
    {
        if (model is null) return;

        isSaving = true;
        SaveError = null;
        SaveMessage = null;

        var birthDateOnly = DateOnly.FromDateTime(birthDate);
        var cmd = model.ToUpdateUserCommand(birthDateOnly);

        var result = await Mediator.Send(cmd);

        if (result.IsSuccess)
        {
            SaveMessage = "Saved successfully.";
        }
        else
        {
            SaveError = result.Error?.Message ?? "Save failed.";
        }

        isSaving = false;
    }

    private Task GoBack()
    {
        Nav.NavigateTo("/users");
        return Task.CompletedTask;
    }
}
