@page "/users/{UserId:guid}"

<h3>Felhasználó adatai</h3>

@if (isLoading)
{
    <p>Betöltés...</p>
}
else if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div style="color:#c00">@errorMessage</div>
}
else if (model is not null)
{
    <div style="max-width:520px;">
        <div style="display:grid; grid-template-columns: 1fr; gap:12px;">

            <div>
                <label>Felhasználónév</label>
                <TelerikTextBox @bind-Value="model.UserName" />
            </div>

            <div>
                <label>Email</label>
                <TelerikTextBox @bind-Value="model.Email" />
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <div>
                    <label>Keresztnév</label>
                    <TelerikTextBox @bind-Value="model.FirstName" />
                </div>

                <div>
                    <label>Vezetéknév</label>
                    <TelerikTextBox @bind-Value="model.LastName" />
                </div>
            </div>

            <div>
                <label>Teljes név</label>
                <TelerikTextBox Value="@FullName" ReadOnly="true" />
            </div>

            <div>
                <label>Születési dátum</label>
                <TelerikDatePicker @bind-Value="birthDate" />
            </div>

            <div>
                <label>Születési hely</label>
                <TelerikTextBox @bind-Value="model.BirthPlace" />
            </div>

            <div>
                <label>Város</label>
                <TelerikTextBox @bind-Value="model.City" />
            </div>

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                <TelerikButton ThemeColor="ThemeColor.Light" OnClick="@GoBack">
                    Vissza
                </TelerikButton>

                <TelerikButton ThemeColor="ThemeColor.Success" OnClick="@UpdateAsync" Enabled="@(!isSaving)">
                    @(isSaving ? "Mentés..." : "Update")
                </TelerikButton>
            </div>

            @if (!string.IsNullOrWhiteSpace(saveMessage))
            {
                <div style="color: green;">@saveMessage</div>
            }

            @if (!string.IsNullOrWhiteSpace(saveError))
            {
                <div style="color:#c00">@saveError</div>
            }
        </div>
    </div>
}

@code {
    [Parameter] public Guid UserId { get; set; }

    private UpdateUserModel? model;

    private DateTime birthDate;

    private bool isLoading = true;
    private bool isSaving = false;

    private string? errorMessage;
    private string? saveError;
    private string? saveMessage;

    [Inject] private IMediator Mediator { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private string FullName => model is null ? string.Empty : $"{model.FirstName} {model.LastName}";

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        isLoading = true;
        errorMessage = null;
        saveError = null;
        saveMessage = null;

        try
        {
            var result = await Mediator.Send(new GetUserByIdQuery(UserId));

            if (result.IsSuccess && result.Value is not null)
            {
                model = result.Value.ToUserModel();
                birthDate = model.BirthDate.ToDateTime(TimeOnly.MinValue);
            }
            else
            {
                errorMessage = result.Error?.Message ?? "Felhasználó nem található.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task UpdateAsync()
    {
        if (model is null) return;

        isSaving = true;
        saveError = null;
        saveMessage = null;

        var birthDateOnly = DateOnly.FromDateTime(birthDate);

        var cmd = model.ToUpdateUserCommand(birthDateOnly);

        var result = await Mediator.Send(cmd);

        if (result.IsSuccess)
        {
            saveMessage = "Saved successfully.";
        }
        else
        {
            saveError = result.Error?.Message ?? "Saved successfully.";
        }

        isSaving = false;
    }

    private void GoBack() => Nav.NavigateTo("/users");
}
