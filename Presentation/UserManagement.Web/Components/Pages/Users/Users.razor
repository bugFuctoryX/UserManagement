@page "/users"

<ErrorBoundary @ref="_eb">
    <ChildContent>
        <TelerikButton OnClick="@ReloadAsync" Enabled="@(!isLoading)">Refresh</TelerikButton>

        <UsersGrid Items="users"
                   OnEdit="GoToDetails"
                   OnDeleteRequested="AskDelete" />

        <DeleteUserDialog Visible="@IsDeleteOpen"
                          VisibleChanged="@OnDeleteWindowVisibleChanged"
                          User="@_pendingDelete"
                          OnCancel="@CancelDelete"
                          OnConfirm="@ConfirmDeleteAsync" />

        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div style="color:#c00; margin-top: 12px;">@errorMessage</div>
        }
    </ChildContent>

    <ErrorContent Context="ex">
        <div style="padding:12px;border:1px solid #c00;">
            <b>Error:</b> @ex.GetType().Name<br />
            @ex.Message
        </div>

        <button @onclick="Recover">Try again</button>
    </ErrorContent>
</ErrorBoundary>

@code {
    private IReadOnlyList<UserModel> users = Array.Empty<UserModel>();
    private string? errorMessage;
    private bool isLoading;

    [Inject] private IMediator Mediator { get; set; } = default!;
    [Inject] private NavigationManager Nav { get; set; } = default!;

    private ErrorBoundary? _eb;
    private void Recover() => _eb?.Recover();

    protected override async Task OnInitializedAsync()
    {
        if (RendererInfo.IsInteractive)
        {
            await LoadUsersAsync();
        }
    }

    private async Task ReloadAsync() => await LoadUsersAsync();

    private async Task LoadUsersAsync()
    {
        isLoading = true;
        errorMessage = null;

        var result = await Mediator.Send(new GetUsersQuery());

        if (result.IsSuccess && result.Value is not null)
            users = result.Value.ToUserModels();
        else
            errorMessage = result.Error?.Message ?? "Unable to load users.";

        isLoading = false;
    }

    private void GoToDetails(UserModel model)
    {
        var userId = Uri.EscapeDataString(model.UserId.ToString());
        Nav.NavigateTo($"/users/{userId}");
    }

    private UserModel? _pendingDelete;
    private bool IsDeleteOpen => _pendingDelete is not null;

    private void AskDelete(UserModel u) => _pendingDelete = u;
    private void CancelDelete() => _pendingDelete = null;

    private Task OnDeleteWindowVisibleChanged(bool visible)
    {
        if (!visible) _pendingDelete = null;
        return Task.CompletedTask;
    }

    private async Task ConfirmDeleteAsync()
    {
        if (_pendingDelete is null) return;

        var id = _pendingDelete.UserId;

        var result = await Mediator.Send(new DeleteUserCommand(id));
        if (result.IsSuccess && result.Value)
        {
            errorMessage = null;
            users = users.Where(x => x.UserId != id).ToList();
        }
        else
        {
            errorMessage = result.Error?.Message ?? "Delete failed.";
        }

        _pendingDelete = null;
        await InvokeAsync(StateHasChanged);
    }
}
